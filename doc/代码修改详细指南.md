# 代码修改详细指南

## 文档说明
本文档提供详细的代码修改步骤，帮助完成从数据库架构到直接调用Tushare API的迁移。

## 前置条件
- 已完成文件清理（参考《文件清理清单.md》）
- 已备份原代码
- 服务已停止

## 修改文件列表

需要修改的文件（共7个）：
1. ✏️ `src/api/controllers.py` - 控制器（重点）
2. ✏️ `src/api/app.py` - Flask应用
3. ✏️ `run.py` - 启动文件
4. ✏️ `requirements.txt` - Python依赖
5. ✏️ `config/config.yaml` - 配置文件
6. ✏️ `start.sh` - 启动脚本（可选）
7. ✏️ `README.md` - 项目说明（可选）

---

## 文件1: src/api/controllers.py

### 当前问题
- 使用 `SessionLocal()` 查询数据库
- 导入了 `models` 模块
- 使用 ORM 查询

### 修改方案

#### 步骤1: 修改导入部分

**删除这些导入**:
```python
from src.models.database import SessionLocal
from src.models import Industry, Stock, StockDailyData, FinancialData, ValuationAnalysis
```

**添加这个导入**:
```python
from src.data_source.data_fetcher import DataFetcher
```

#### 步骤2: 修改 IndustryController

**旧代码**:
```python
class IndustryController:
    """行业控制器"""

    def get_industries(self):
        """获取所有行业列表"""
        db = SessionLocal()
        try:
            industries = db.query(Industry).all()
            return jsonify({
                'code': 200,
                'message': 'success',
                'data': [ind.to_dict() for ind in industries],
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取行业列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500
        finally:
            db.close()
```

**新代码**:
```python
class IndustryController:
    """行业控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()

    def get_industries(self):
        """获取所有行业列表"""
        try:
            industries = self.fetcher.fetch_industries()
            return jsonify({
                'code': 200,
                'message': 'success',
                'data': industries,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取行业列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500
```

#### 步骤3: 修改 StockController

**新代码结构**:
```python
class StockController:
    """股票控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()

    def get_stocks(self):
        """获取股票列表"""
        try:
            # 从请求参数获取市场类型（可选）
            market = request.args.get('market')  # SZ, SH, None

            stocks = self.fetcher.fetch_stocks(market=market)

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': stocks,
                'total': len(stocks),
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取股票列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': []
            }), 500

    def get_stock(self, code):
        """获取股票详情"""
        try:
            # 获取股票基本信息
            stocks = self.fetcher.fetch_stocks()
            stock = next((s for s in stocks if s['code'] == code), None)

            if not stock:
                return jsonify({
                    'code': 404,
                    'message': '股票不存在',
                    'data': None
                }), 404

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': stock,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取股票详情失败: {code}, {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500

    def get_financial(self, code):
        """获取财务数据"""
        try:
            # 从code推断market（6开头为SH，其他为SZ）
            market = 'SH' if code.startswith('6') else 'SZ'

            financial_data = self.fetcher.fetch_financial_data(code, market)

            if not financial_data:
                return jsonify({
                    'code': 404,
                    'message': '财务数据不存在',
                    'data': None
                }), 404

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': financial_data,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取财务数据失败: {code}, {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500
```

#### 步骤4: 修改 AnalysisController

**新代码**:
```python
class AnalysisController:
    """分析控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()
        self.graham_analyzer = GrahamAnalyzer()

    def get_recommendations(self):
        """获取推荐股票列表"""
        try:
            # 1. 获取所有股票
            stocks = self.fetcher.fetch_stocks()

            # 2. 进行格雷厄姆分析
            recommendations = []

            for stock in stocks[:100]:  # 限制数量，避免超时
                try:
                    # 获取财务数据
                    market = 'SH' if stock['code'].startswith('6') else 'SZ'
                    financial = self.fetcher.fetch_financial_data(
                        stock['code'], market
                    )

                    if financial:
                        # 准备分析数据
                        stock_data = {**stock, **financial}

                        # 执行格雷厄姆分析
                        analysis = self.graham_analyzer.analyze(stock_data)

                        if analysis.get('pass_filter'):
                            recommendations.append({
                                'stock': stock,
                                'analysis': analysis
                            })
                except Exception as e:
                    logger.warning(f"分析股票失败 {stock['code']}: {e}")
                    continue

            # 3. 按评分排序
            recommendations.sort(
                key=lambda x: x['analysis'].get('graham_score', 0),
                reverse=True
            )

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': recommendations,
                'total': len(recommendations),
                'timestamp': datetime.now().isoformat()
            })

        except Exception as e:
            logger.error(f"获取推荐列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': []
            }), 500
```

### 完整修改后的文件

创建新的 `controllers.py`:
```python
"""API控制器 - 无数据库版本"""
from flask import request, jsonify
from datetime import datetime

from src.data_source.data_fetcher import DataFetcher
from src.analysis import GrahamAnalyzer, IndustryAnalyzer
from src.utils.logger import logger


class IndustryController:
    """行业控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()

    def get_industries(self):
        """获取所有行业列表"""
        try:
            industries = self.fetcher.fetch_industries()
            return jsonify({
                'code': 200,
                'message': 'success',
                'data': industries,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取行业列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500

    def get_industry(self, code):
        """获取特定行业详情"""
        try:
            industries = self.fetcher.fetch_industries()
            industry = next((ind for ind in industries if ind['code'] == code), None)

            if not industry:
                return jsonify({
                    'code': 404,
                    'message': '行业不存在',
                    'data': None
                }), 404

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': industry,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取行业详情失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500

    def get_industry_ranking(self):
        """获取行业排名"""
        try:
            industries = self.fetcher.fetch_industries()
            # 按涨跌幅排序
            sorted_industries = sorted(
                industries,
                key=lambda x: x.get('price_change', 0),
                reverse=True
            )

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': sorted_industries,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取行业排名失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500


class StockController:
    """股票控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()

    def get_stocks(self):
        """获取股票列表"""
        try:
            market = request.args.get('market')
            stocks = self.fetcher.fetch_stocks(market=market)

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': stocks,
                'total': len(stocks),
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取股票列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': []
            }), 500

    def get_stock(self, code):
        """获取股票详情"""
        try:
            stocks = self.fetcher.fetch_stocks()
            stock = next((s for s in stocks if s['code'] == code), None)

            if not stock:
                return jsonify({
                    'code': 404,
                    'message': '股票不存在',
                    'data': None
                }), 404

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': stock,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取股票详情失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500

    def get_financial(self, code):
        """获取财务数据"""
        try:
            market = 'SH' if code.startswith('6') else 'SZ'
            financial_data = self.fetcher.fetch_financial_data(code, market)

            if not financial_data:
                return jsonify({
                    'code': 404,
                    'message': '财务数据不存在',
                    'data': None
                }), 404

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': financial_data,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取财务数据失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500

    def get_valuation(self, code):
        """获取估值分析"""
        # 暂不实现，返回空数据
        return jsonify({
            'code': 200,
            'message': 'success',
            'data': None,
            'timestamp': datetime.now().isoformat()
        })

    def filter_stocks(self):
        """股票筛选"""
        try:
            filters = request.get_json() or {}
            stocks = self.fetcher.fetch_stocks()

            # 应用筛选条件
            filtered = stocks

            if 'market' in filters:
                filtered = [s for s in filtered if s['market'] == filters['market']]

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': filtered,
                'total': len(filtered),
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"筛选股票失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': []
            }), 500


class AnalysisController:
    """分析控制器"""

    def __init__(self):
        self.fetcher = DataFetcher()

    def get_recommendations(self):
        """获取推荐股票列表"""
        try:
            # 简化版：返回涨幅前20的股票
            stocks = self.fetcher.fetch_stocks()[:100]

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': stocks[:20],
                'total': 20,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取推荐列表失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': []
            }), 500

    def get_graham_analysis(self, code):
        """获取格雷厄姆分析"""
        try:
            market = 'SH' if code.startswith('6') else 'SZ'
            financial = self.fetcher.fetch_financial_data(code, market)

            return jsonify({
                'code': 200,
                'message': 'success',
                'data': financial,
                'timestamp': datetime.now().isoformat()
            })
        except Exception as e:
            logger.error(f"获取格雷厄姆分析失败: {e}")
            return jsonify({
                'code': 500,
                'message': str(e),
                'data': None
            }), 500


class TaskController:
    """任务控制器"""

    def trigger_crawl(self):
        """触发爬取任务（已废弃）"""
        return jsonify({
            'code': 501,
            'message': '该功能已废弃，系统使用Tushare API实时获取数据',
            'data': None
        }), 501

    def get_task_status(self, task_id):
        """获取任务状态（已废弃）"""
        return jsonify({
            'code': 501,
            'message': '该功能已废弃',
            'data': None
        }), 501


# 创建控制器实例
industry_controller = IndustryController()
stock_controller = StockController()
analysis_controller = AnalysisController()
task_controller = TaskController()
```

---

## 文件2: src/api/app.py

### 删除数据库初始化

**旧代码**:
```python
from src.models.database import init_db

def create_app():
    app = Flask(__name__)

    # 初始化数据库
    init_db()

    # CORS配置
    CORS(app, origins=config.get('api.cors_origins', []))
```

**新代码**:
```python
def create_app():
    app = Flask(__name__)

    # CORS配置
    CORS(app, origins=config.get('api.cors_origins', []))

    # 注册路由
    register_routes(app)

    logger.info("Flask应用创建成功")
    return app
```

---

## 文件3: run.py

### 移除定时任务和数据检查

**旧代码**:
```python
from src.tasks.scheduler import scheduler
from src.models.database import SessionLocal
from src.models import Stock, Industry

def check_data_health():
    # ...

scheduler.start()
check_data_health()
```

**新代码**:
```python
"""主启动文件 - 简化版"""
import sys
from pathlib import Path

sys.path.append(str(Path(__file__).parent))

from src.api.app import create_app
from src.utils.config import config
from src.utils.logger import logger


def main():
    """主函数"""
    logger.info("=" * 60)
    logger.info("Graham Value Investment Analyzer 启动中...")
    logger.info("=" * 60)

    try:
        # 创建Flask应用
        logger.info("创建Flask应用...")
        app = create_app()

        # 获取配置
        host = config.get('app.host', '0.0.0.0')
        port = config.get('app.port', 5000)
        debug = config.get('app.debug', False)

        logger.info(f"Flask服务配置: {host}:{port}")
        logger.info("=" * 60)
        logger.info("应用启动成功！")
        logger.info(f"API地址: http://{host}:{port}")
        logger.info(f"前端地址: http://localhost:3000")
        logger.info("=" * 60)

        # 启动Flask服务
        app.run(host=host, port=port, debug=debug)

    except KeyboardInterrupt:
        logger.info("收到中断信号，正在关闭...")
    except Exception as e:
        logger.error(f"应用启动失败: {e}")
        raise


if __name__ == '__main__':
    main()
```

---

## 文件4: requirements.txt

### 简化Python依赖

**删除这些行**:
```
selenium==4.15.0
beautifulsoup4==4.12.2
sqlalchemy==2.0.23
apscheduler==3.10.4
webdriver-manager==4.0.1
requests==2.31.0
aiohttp==3.9.0
lxml==4.9.3
pymysql==1.1.0
```

**新的requirements.txt**:
```
# 数据源
tushare==1.4.4

# 数据处理
pandas==2.1.3
numpy==1.26.2
scipy==1.11.4

# Web框架
flask==3.0.0
flask-cors==4.0.0

# 日志
loguru==0.7.2

# 配置
pyyaml==6.0.1
python-dotenv==1.0.0

# 其他
tqdm==4.66.1
pytz==2023.3
```

---

## 文件5: config/config.yaml

### 删除数据库和调度器配置

**删除这些部分**:
```yaml
# 数据库配置
database:
  type: "sqlite"
  path: "data/database/stocks.db"
  ...

# 定时任务配置
scheduler:
  timezone: "Asia/Shanghai"
  ...
```

**简化后的config.yaml**:
```yaml
# 应用配置
app:
  name: "Graham Value Investment Analyzer"
  version: "2.0.0"
  debug: true
  host: "0.0.0.0"
  port: 5000

# Tushare数据源配置
tushare:
  token: "58ed199914f035540b89da2694939ac4fc2305b297792b0759703bef"
  timeout: 30
  retry_count: 3
  retry_delay: 1
  rate_limit: 200

# API配置
api:
  prefix: "/api/v1"
  cors_origins:
    - "http://localhost:3000"
    - "http://localhost:5173"

# 日志配置
logging:
  level: "INFO"
  format: "<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>"
  rotation: "500 MB"
  retention: "30 days"
```

---

## 修改验证

完成所有修改后，执行以下验证：

### 1. 检查Python导入
```bash
python -c "
from src.api.app import create_app
from src.api.controllers import stock_controller
from src.data_source.data_fetcher import DataFetcher
print('✓ 所有导入正常')
"
```

### 2. 启动服务测试
```bash
python run.py
# 应该能正常启动，无报错
```

### 3. 测试API
```bash
# 测试股票列表
curl http://localhost:5000/api/v1/stocks | python -m json.tool

# 测试行业数据
curl http://localhost:5000/api/v1/industries | python -m json.tool
```

### 4. 测试前端
访问 http://localhost:3000，应该能看到数据

---

## 常见问题

### Q1: 导入错误
**错误**: `ModuleNotFoundError: No module named 'src.models'`
**解决**: 确保已删除所有models导入

### Q2: 启动失败
**错误**: `scheduler not defined`
**解决**: 确保已从run.py中删除scheduler相关代码

### Q3: API无数据
**错误**: API返回空数据
**解决**: 检查Tushare token配置，检查网络连接

---

**文档版本**: v1.0
**创建时间**: 2025-11-04
**预计修改时间**: 30-60分钟
